# PostgreSQL Installation Automation

## Описание
Данный проект автоматизирует установку и настройку PostgreSQL на нескольких серверах с помощью Ansible, обеспечивая удобство и надежность развертывания.

Основные компоненты:
- `data.py` — обрабатывает введённые IP-адреса серверов и обновляет файл `inventory.ini`.
- `run.py/run_pass.py` — основной скрипт, который запускает `data.py`, выполняет Ansible playbook `playbook.yml` с помощью команды `ansible-playbook Gimipts-PG_start/ansible_run/playbook.yml -i Gimipts-PG_start/ansible_run/inventory.ini --ask-become-pass`, и после завершения очищает файл `inventory.ini`.

## Быстрый старт

### 1. Клонирование репозитория:
```bash
git clone https://github.com/MCMXCVIII-XXI/Gimipts-PG_start.git
```
переходим в директорию:
```
cd Gimipts-PG_start/
```

### 2. Создание и активация виртуального окружения:
```bash
python -m venv venv 
source venv/bin/activate
```

### 3. Установка зависимостей

Перейдите в директорию `Gimipts-PG_start` и выполните:
```bash
pip install .
pip install -r requirements.txt
```
Если вы находитесь вне директории, укажите полный путь:
```bash
pip install /путь/к/Gimipts-PG_start/.
pip install -r /путь/к/Gimipts-PG_start/requirements.txt
```

### 4. Запуск программы:

Запуск с добавлением SSH-ключа в ssh-agent
Позволяет вводить пароль от приватного ключа один раз за сессию:
```bash
gimipts -H "IP_адрес1 IP_адрес2"
```

Запуск без добавления ключа в ssh-agent
Требует ввод пароля от приватного ключа при каждом подключении:
```bash
gimipts-pass -H "IP_адрес1 IP_адрес2"
```

После запуска программа запросит пароль `BECOME password:` — он необходим для повышения привилегий (sudo) на целевых серверах.

## Что делает playbook.yml

- Определяет сервер с наименьшей загрузкой из всех хостов.
- Устанавливает PostgreSQL 15 и необходимые пакеты на выбранном сервере.
- Настраивает PostgreSQL для прослушивания на всех интерфейсах.
- Конфигурирует доступ к базе данных с использованием md5 аутентификации.
- Создаёт пользователей `postgres` и `student` с соответствующими паролями и правами.
- Тестирует подключение к базе данных под пользователем `student`.
- Перезапускает сервис PostgreSQL при изменениях конфигурации.

## Настройка

- В файле `playbook.yml` можно изменить версию PostgreSQL, пароли и другие параметры установки.
- В `data.py` настраивается добавление серверов в инвентарь.
- В `run.py/run_pass.py` можно настроить команду `ansible-playbook`.

## Проблемы и решения

### 1. Проблема с вводом пароля приватного ключа при использовании ansible_runner
При запуске через `ansible_runner` возникала проблема с вводом пароля от приватного ключа: программа останавливалась, но не запрашивала пароль. При прямом запуске `playbook.yml` через `ansible-playbook` всё работало корректно.

**Решение:**  
Для обхода этой проблемы используется запуск playbook через библиотеку `subprocess` с вызовом команды `ansible-playbook` (как реализовано в `run.py`). Также можно настроить передачу ключей в `ssh-agent` при использовании `ansible_runner`.

### 2. Проблема с заменой cowsay для вывода в Ansible
Не удалось заменить `cowsay` в Ansible для более чёткого и понятного вывода.

**Решение:**  
Для улучшения читаемости вывода были даны более информативные и понятные названия для каждого task в playbook.

## Лицензия
MIT License
