# PostgreSQL Installation Automation

## Описание
Данный проект автоматизирует установку и настройку PostgreSQL на нескольких серверах с помощью Ansible, обеспечивая удобство и надежность развертывания.

Основные компоненты:
- `data.py` — обрабатывает введённые IP-адреса серверов и обновляет файл `inventory.ini`.
- `run_pass.py` — основной скрипт, который запускает `data.py`, выполняет Ansible playbook `playbook.yml` с помощью команды `ansible-playbook pg_install/ansible_run/playbook.yml -i pg_install/ansible_run/inventory.ini --ask-become-pass`, и после завершения очищает файл `inventory.ini`.

## Быстрый старт

### 1. Создание и активация виртуального окружения
```bash
python -m venv venv  # в директории pg_install
source venv/bin/activate
```

### 2. Установка зависимостей
Перейдите в директорию `pg_install` и выполните:
```bash
pip install .
pip install -r requirements.txt
```
Если вы находитесь вне директории, укажите полный путь:
```bash
pip install /путь/к/pg_install/.
pip install -r /путь/к/pg_install/requirements.txt
```

### 3. Запуск программы

#### 3.1 Запуск с добавлением SSH-ключа в ssh-agent
Позволяет вводить пароль от приватного ключа один раз за сессию:
```bash
gimipts -H "IP_адрес1 IP_адрес2"
```

#### 3.2 Запуск без добавления ключа в ssh-agent
Требует ввод пароля от приватного ключа при каждом подключении:
```bash
gimipts-pass -H "IP_адрес1 IP_адрес2"
```

## Что делает playbook.yml

- Определяет сервер с наименьшей загрузкой из всех хостов.
- Устанавливает PostgreSQL 15 и необходимые пакеты на выбранном сервере.
- Настраивает PostgreSQL для прослушивания на всех интерфейсах.
- Конфигурирует доступ к базе данных с использованием md5 аутентификации.
- Создаёт пользователей `postgres` и `student` с соответствующими паролями и правами.
- Тестирует подключение к базе данных под пользователем `student`.
- Перезапускает сервис PostgreSQL при изменениях конфигурации.

## Настройка

- В файле `pg_install/ansible_run/playbook.yml` можно изменить версию PostgreSQL, пароли и другие параметры установки.
- В `pg_install/gimipts_project/data.py` настраивается добавление серверов в инвентарь.

## Часто встречающиеся проблемы и решения

### 1. Проблема с вводом пароля приватного ключа при использовании ansible_runner
При запуске через `ansible_runner` возникала проблема с вводом пароля от приватного ключа: программа останавливалась, но не запрашивала пароль. При прямом запуске `playbook.yml` через `ansible-playbook` всё работало корректно.

**Решение:**  
Для обхода этой проблемы используется запуск playbook через библиотеку `subprocess` с вызовом команды `ansible-playbook` (как реализовано в `run.py`). Также можно настроить передачу ключей в `ssh-agent` при использовании `ansible_runner`.

### 2. Проблема с заменой cowsay для вывода в Ansible
Не удалось заменить `cowsay` в Ansible для более чёткого и понятного вывода.

**Решение:**  
Для улучшения читаемости вывода были даны более информативные и понятные названия для каждого task в playbook.

## Лицензия
MIT License
